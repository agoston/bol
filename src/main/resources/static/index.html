<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <title>Lubang Menggali</title>
    <meta charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="game.css"/>
    <script src="jquery-2.1.1.min.js"></script>

    <script charset="utf-8">

        var player = {};
        var opponent = {};
        var match = {};
        var whichPlayer = 0;

        var anim = null;

        $(function () {
            $.ajaxSetup({
                dataType: "json",
                error: function (jqXHR, textStatus, errorThrown) {
                    // TODO: [AH] add better error reporting
                    window.alert(textStatus + "\n" + errorThrown);
                }
            });

            $("input.login:button").click(function (e) {
                player.name = $("input.login:text").val();
                login();
                e.preventDefault();
            });
        });

        function login() {
            $.ajax({
                url: "/player?name=" + player.name,
                type: "POST",
                success: function (data, textStatus, jqXHR) {
                    console.log(data);
                    player.id = data.id;
                    anim = $("div.login").fadeOut().promise();
                    startMatch();
                }
            });
        }

        function startMatch() {
            $.ajax({
                url: "/player/" + player.id + "/match",
                type: "POST",
                success: function (data, textStatus, jqXHR) {
                    console.log(data);

                    if (jqXHR.status == 202) {
                        window.setTimeout(startMatch, 1000);
                        return;
                    }

                    anim.done(function() {
                        $("div.board").fadeIn();
                    });

                    match = data;
                    if (match.names[0] == player.name) {
                        whichPlayer = 0;
                    } else if (match.names[1] == player.name) {
                        whichPlayer = 1;
                    } else {
                        windows.alert("Can't find player!");
                        return;
                    }

                    drawBoard();
                }
            });
        }

        function drawBoard() {
            var boardSelector = $("div.board");
            boardSelector.empty();

            // names
            for (var i = 0; i < 2; i++) {
                var nameDiv = document.createElement('div');
                nameDiv.setAttribute("class", "names");
                $(nameDiv).css({
                    position: "absolute",
                    left: "100px",
                    top: (i * 200) + "px",
                    width: "500px",
                    height: "100px",
                    margin: "5px",
                    "text-align": "center",
                    "line-height": "100px"
                })
                nameDiv.innerHTML = match.names[i];
                $(nameDiv).appendTo(boardSelector);
            }

            // pits
            for (var i = 0; i < 2; i++) {
                for (var j = 0; j < 6; j++) {
                    var newDiv = document.createElement('div');
                    newDiv.setAttribute("id", "");
                    newDiv.setAttribute("class", i == whichPlayer ? "playertiles" : "opponenttiles");
                    $(newDiv).css({
                        position: "absolute",
                        left: (200 + j * 50) + "px",
                        top: (100 + i * 50) + "px",
                        width: "40px",
                        height: "40px",
                        margin: "5px",
                        "text-align": "center",
                        "line-height": "40px"
                    });
                    newDiv.innerHTML = match.pits[i][j];
                    $(newDiv).appendTo(boardSelector);
                }
            }

            // lubang menggali
            for (var i = 0; i < 2; i++) {
                var newDiv = document.createElement('div');
                newDiv.setAttribute("id", "");
                newDiv.setAttribute("class", "lubangmenggali");
                $(newDiv).css({
                    position: "absolute",
                    left: (100 + i * 400) + "px",
                    top: "100px",
                    width: "90px",
                    height: "90px",
                    margin: "5px",
                    "text-align": "center",
                    "line-height": "90px"
                });
                newDiv.innerHTML = match.pits[i][6];
                $(newDiv).appendTo(boardSelector);
            }


        }

    </script>
</head>
<body>

<div class="login">
    You are: <input type="text" class="login" name="name" value="Anonymous"/><input type="button" value="Start!"
                                                                                    class="login"/>
</div>

<div class="board"/>

</body>
